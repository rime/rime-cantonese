name: Compilation check

on:
  push:
    branches:
      - main
    paths:
      - '*.yaml'  # root directory only
      - '*.txt'
      - 'opencc/**'
  pull_request:
    branches:
      - main
    paths:
      - '*.yaml'
      - '*.txt'
      - 'opencc/**'
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install rime engine
        run: |
          sudo apt-get install ibus-rime -y
      - name: Install rime-cantonese files from checked out branch
        run: |
          chmod u+x ./.ci/*
          export rime_dir=~/.config/ibus/rime
          curl -fsSL https://git.io/rime-install | bash -s -- :preset emoji CanCLID/rime-loengfan custom:set:config=default,key=installed_from,value=rime-cantonese custom:clear_schema_list custom:add:schema=jyut6ping3 custom:add:schema=cangjie5 custom:add:schema=stroke custom:add:schema=luna_pinyin lotem/rime-octagram-data lotem/rime-octagram-data@hant lotem/rime-octagram-data:customize:schema=jyut6ping3,model=hant
          cp ./*.{txt,yaml} $rime_dir 
          cp ./opencc/* $rime_dir

# Use cp ./** in lieu of ./.ci/install_schema.sh to ensure that action is running on checked out branch (e.g. PR refs)

      - name: Compile
        run: |
          chmod u+wx ~/.config/ibus/rime/*
          rime_deployer --build ~/.config/ibus/rime 2> log.tmp
      - name: Check
        run: |
          cat log.tmp
          exit $(cat log.tmp | grep -c ^[EW]) 

  check_jyutping_cpp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - run: |
          echo "Installing prerequisites..."
          sudo apt-get install libboost-all-dev
      - run: |
          echo "Building checker from source..."
          export LD_LIBRARY_PATH="/usr/lib/boost/lib"
          g++ .ci/checker.cpp -o checker.o -Ofast -I/usr/include/boost -L/usr/lib/boost/lib -lboost_regex
          chmod u+x ./checker.o
      - run: |
          echo "Checking jyut6ping3.dict.yaml"
          time ./checker.o jyut6ping3.dict.yaml